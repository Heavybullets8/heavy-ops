env:
  # General
  TZ: "${TIMEZONE}"
  IMMICH_TRUSTED_PROXIES: "10.96.0.0/16"
  PUBLIC_IMMICH_SERVER_URL: "https://photos.${SECRET_DOMAIN}"

  # Redis
  REDIS_HOSTNAME: "dragonfly.database.svc.cluster.local"
  REDIS_PORT: "6379"
  REDIS_DBINDEX: "2"

  # Database
  DB_DATABASE_NAME: &dbName "immich"
  DB_HOSTNAME: &dbHost "postgres16-rw.database.svc.cluster.local"
  DB_USERNAME: &dbUser "{{ .IMMICH_POSTGRES_USER }}"
  DB_PASSWORD: &dbPass "{{ .IMMICH_POSTGRES_PASS }}"
  DB_VECTOR_EXTENSION: pgvector

immich:
  configuration:
    oauth:
      autoLaunch: true
      autoRegister: true
      buttonText: "Login with OAuth"
      clientId: "{{ .IMMICH_OAUTH_CLIENT_ID }}"
      clientSecret: "{{ .IMMICH_OAUTH_CLIENT_SECRET_PLAIN }}"
      defaultStorageQuota: 0
      enabled: true
      issuerUrl: "https://auth.${SECRET_DOMAIN}"
      mobileOverrideEnabled: false
      mobileRedirectUri: "app.immich:///oauth-callback"
      scope: "openid email profile"
      signingAlgorithm: "RS256"
      profileSigningAlgorithm: "none"
      storageLabelClaim: "preferred_username"
      storageQuotaClaim: "immich_quota"
    notifications:
      smtp:
        enabled: true
        from: "immich@${SECRET_DOMAIN}"
        replyTo: "support@${SECRET_DOMAIN}"
        transport:
          ignoreCert: false
          host: "smtp.migadu.com"
          port: 465
          username: "{{ .SMTP_USER }}"
          password: "{{ .SMTP_PASS }}"

  persistence:
    library:
      existingClaim: immich

server:
  ingress:
    main:
      ingressClassName: external
      annotations:
        external-dns.alpha.kubernetes.io/target: external.${SECRET_DOMAIN}
        nginx.ingress.kubernetes.io/proxy-body-size: "0"
      hosts:
        - host: "photos.${SECRET_DOMAIN}"
          paths:
            - path: /
              pathType: Prefix

  # Had to run the following commands in CNPG Primary pod to get working:
  # `psql`
  # `\c immich`
  # `CREATE EXTENSION vector;`
  # `CREATE EXTENSION earthdistance CASCADE;`
  initContainers:
    init-db:
      image: ghcr.io/onedr0p/postgres-init:16
      env:
        - name: INIT_POSTGRES_DBNAME
          value: *dbName
        - name: INIT_POSTGRES_HOST
          value: *dbHost
        - name: INIT_POSTGRES_USER
          value: *dbUser
        - name: INIT_POSTGRES_PASS
          value: *dbPass
        - name: INIT_POSTGRES_SUPER_PASS
          value: "{{ .CNPG_SUPER_PASS }}"
