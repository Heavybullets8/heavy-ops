---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: authelia
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: authelia-secret
    template:
      engineVersion: v2
      data:
        # Authelia
        hmac_secret: "{{ .HMAC_SECRET }}"
        jwt_reset_secret: "{{ .JWT_RESET_SECRET }}"
        session_secret: "{{ .SESSION_SECRET }}"
        storage_encryption_key: "{{ .STORAGE_ENCRYPTION_KEY }}"
        jwks_pem: "{{ .JWKS_PRIV.pem }}"

        # Glauth
        ldap_user: "{{ .GLAUTH_USER }}"
        ldap_password: "{{ .GLAUTH_SEARCH_PASSWORD }}"
        ldap_base_dn: "{{ .GLAUTH_BASE_DN }}"

        # Duo
        duo_hostname: "{{ .DUO_HOSTNAME }}"
        duo_integration_key: "{{ .DUO_INTEGRATION_KEY }}"
        duo_secret_key: "{{ .DUO_SECRET_KEY }}"

        # SMTP
        smtp_username: "{{ .SMTP_USERNAME }}"
        smtp_password: "{{ .SMTP_PASSWORD }}"
        grafana_oauth_client_secret: "{{ .GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET }}"
  dataFrom:
    - extract:
        key: authelia-secret
    - extract:
        key: duo-secret
    - extract:
        key: glauth-secret
    - extract:
        key: grafana-secret
    - extract:
        key: smtp-secret
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: authelia-db-secret
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: authelia-db-secret
    template:
      engineVersion: v2
      data:
        INIT_POSTGRES_DBNAME: authelia
        INIT_POSTGRES_HOST: postgres16-rw.database.svc.cluster.local
        INIT_POSTGRES_USER: "{{ .AUTHELIA_POSTGRES_USERNAME }}"
        INIT_POSTGRES_PASS: "{{ .AUTHELIA_POSTGRES_PASSWORD }}"
        INIT_POSTGRES_SUPER_PASS: "{{ .POSTGRES_SUPER_PASS }}"
  dataFrom:
    - extract:
        key: authelia-secret
    - extract:
        key: cloudnative-pg-secret
---
